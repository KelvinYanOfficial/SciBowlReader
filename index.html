<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>SciBowl QBReader</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script type="text/javascript" id="MathJax-script" async
    src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      display: flex;
      min-height: 100vh;
      background: #f0f0f0;
    }
    #sidebar {
      width: 250px;
      background: #003366;
      color: white;
      padding: 20px;
    }
    #sidebar h2 {
      font-size: 18px;
      margin-bottom: 10px;
    }
    #sidebar label {
      display: block;
      margin-bottom: 6px;
    }
    #main {
      flex: 1;
      padding: 30px;
    }
    button {
      margin-top: 10px;
      padding: 8px 12px;
      font-size: 16px;
      background: #0055aa;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    button:hover {
      background: #0077cc;
    }
    .section {
      margin-bottom: 20px;
    }
    #readerLine {
      font-size: 18px;
      margin-top: 20px;
      min-height: 60px;
      background: white;
      padding: 15px;
      border-radius: 8px;
    }
    #speedSlider {
      width: 100%;
      margin-top: 5px;
    }
    #timer {
      font-weight: bold;
      color: darkred;
      margin-top: 10px;
    }
    #answerInputDiv, #bonusInputDiv, #answer, #bonusAnswer, #bonus, #timer {
      display: none;
      margin-top: 15px;
    }
  </style>
</head>
<body>
  <div id="sidebar">
    <h2>Categories</h2>
    <div id="categoryList">
      <label><input type="checkbox" value="PHYSICS" /> Physics</label>
      <label><input type="checkbox" value="CHEMISTRY" /> Chemistry</label>
      <label><input type="checkbox" value="BIOLOGY" /> Biology</label>
      <label><input type="checkbox" value="EARTH AND SPACE" /> Earth & Space</label>
      <label><input type="checkbox" value="ENERGY" /> Energy</label>
      <label><input type="checkbox" value="MATH" /> Math</label>
      <label><input type="checkbox" value="GENERAL SCIENCE" /> General Science</label>
    </div>

    <h2>Difficulty</h2>
    <div id="difficultyList">
      <label><input type="checkbox" value="middle_school" /> Middle School</label>
      <label><input type="checkbox" value="high_school" /> High School</label>
    </div>

    <h2>Speed (Recommended: 5–8)</h2>
    <input type="range" min="1" max="10" value="7" id="speedSlider" />
    <div id="speedLabel">Speed: 7</div>
  </div>

  <div id="main">
    <h1>🔬 SciBowl QBReader</h1>
    <div class="section">
      <button onclick="loadQuestion()">Load Question</button>
      <button id="buzzBtn" onclick="buzz()" style="display:none">Buzz!</button>
      <div id="timer"></div>
    </div>

    <div id="readerLine" class="section"></div>

    <div id="answerInputDiv">
      <input type="text" id="userAnswer" placeholder="Enter your answer..." />
      <button onclick="submitAnswer()">Submit</button>
    </div>

    <div id="answer"></div>

    <div id="bonus" class="section"></div>
    <div id="bonusInputDiv">
      <input type="text" id="userBonus" placeholder="Enter bonus..." />
      <button onclick="submitBonus()">Submit Bonus</button>
    </div>
    <div id="bonusAnswer"></div>
  </div>

  <script>
    let questionData = null;
    let currentWords = [], wordIndex = 0, interval = null;
    let buzzed = false, readingDone = false;
    let timerInterval = null, timerCount = 0;
    const reader = document.getElementById("readerLine");

    document.getElementById("speedSlider").addEventListener("input", function () {
      document.getElementById("speedLabel").textContent = "Speed: " + this.value;
    });

    async function loadQuestion() {
      resetAll();

      const cats = getChecked("categoryList");
      const diffs = getChecked("difficultyList");
      const body = {};
      if (cats.length) body.categories = cats;
      if (diffs.length) body.difficulties = diffs;

      const res = await fetch("https://sci-bowl-proxy.onrender.com/api/random", {
        method: Object.keys(body).length ? "POST" : "GET",
        headers: { "Content-Type": "application/json" },
        body: Object.keys(body).length ? JSON.stringify(body) : null
      });
      const data = await res.json();
      questionData = data.questions[0];
      currentWords = questionData.tossup_question.split(" ");
      wordIndex = 0;
      readingDone = false;
      buzzed = false;

      startReading();
    }

    function getChecked(id) {
      return Array.from(document.querySelectorAll(`#${id} input:checked`)).map(cb => cb.value);
    }

    function resetAll() {
      clearInterval(interval);
      clearInterval(timerInterval);
      document.getElementById("readerLine").innerHTML = "";
      document.getElementById("timer").style.display = "none";
      document.getElementById("buzzBtn").style.display = "inline";
      document.getElementById("answerInputDiv").style.display = "none";
      document.getElementById("answer").style.display = "none";
      document.getElementById("bonus").style.display = "none";
      document.getElementById("bonusInputDiv").style.display = "none";
      document.getElementById("bonusAnswer").style.display = "none";
      document.getElementById("userAnswer").value = "";
      document.getElementById("userBonus").value = "";
    }

    function startReading() {
interval = setInterval(() => {
  if (wordIndex < currentWords.length) {
    reader.innerHTML += currentWords[wordIndex++] + " ";
  } else {
    clearInterval(interval);
    readingDone = true;
    MathJax.typesetPromise([reader]);
    if (!buzzed) startTimer(5, "Buzz Timer", () => {
      document.getElementById("buzzBtn").style.display = "none";
      showAnswer();
    });
  }
}, speed);

    function buzz() {
      if (!readingDone && !buzzed) clearInterval(interval);
      buzzed = true;
      document.getElementById("buzzBtn").style.display = "none";
      document.getElementById("answerInputDiv").style.display = "block";
      startTimer(10, "Answer Timer", () => {
        document.getElementById("answerInputDiv").style.display = "none";
        showAnswer();
      });
    }

    function startTimer(seconds, label, callback) {
      timerCount = seconds;
      const timer = document.getElementById("timer");
      timer.style.display = "block";
      timer.textContent = `${label}: ${timerCount}`;
      timerInterval = setInterval(() => {
        timerCount--;
        timer.textContent = `${label}: ${timerCount}`;
        if (timerCount <= 0) {
          clearInterval(timerInterval);
          timer.style.display = "none";
          callback();
        }
      }, 1000);
    }

    function submitAnswer() {
      clearInterval(timerInterval);
      const user = document.getElementById("userAnswer").value.toLowerCase();
      const correct = questionData.tossup_answer.toLowerCase();
      const result = correct.includes(user) ? "✅ Correct!" : "❌ Incorrect.";
      document.getElementById("answer").innerHTML = `${result}<br><b>Answer:</b> ${questionData.tossup_answer}`;
      document.getElementById("answer").style.display = "block";

      if (result.includes("Correct")) showBonus();
      else showAnswer();
    }

    function showAnswer() {
      reader.innerHTML = questionData.tossup_question;
      MathJax.typesetPromise([reader]);
      document.getElementById("answer").innerHTML = `<b>Answer:</b> ${questionData.tossup_answer}`;
      document.getElementById("answer").style.display = "block";
    }

    function showBonus() {
      document.getElementById("bonus").innerHTML = `Bonus: ${questionData.bonus_question}`;
      MathJax.typesetPromise([document.getElementById("bonus")]);
      document.getElementById("bonus").style.display = "block";
      document.getElementById("bonusInputDiv").style.display = "block";
      startTimer(20, "Bonus Timer", () => {
        document.getElementById("bonusInputDiv").style.display = "none";
        document.getElementById("bonusAnswer").innerHTML = `<b>Bonus Answer:</b> ${questionData.bonus_answer}`;
        document.getElementById("bonusAnswer").style.display = "block";
      });
    }

    function submitBonus() {
      clearInterval(timerInterval);
      document.getElementById("bonusAnswer").innerHTML = `<b>Bonus Answer:</b> ${questionData.bonus_answer}`;
      document.getElementById("bonusAnswer").style.display = "block";
    }
  </script>
</body>
</html>
