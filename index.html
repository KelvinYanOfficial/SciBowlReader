<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>SciBowl QBReader</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      display: flex;
      height: 100vh;
      background-color: #f0f2f5;
    }
    .sidebar {
      width: 250px;
      background-color: #ffffff;
      padding: 20px;
      border-right: 1px solid #ccc;
      overflow-y: auto;
    }
    .main {
      flex-grow: 1;
      padding: 20px;
      display: flex;
      flex-direction: column;
    }
    h1 {
      margin-top: 0;
    }
    button {
      background-color: #007bff;
      color: white;
      border: none;
      padding: 10px 16px;
      border-radius: 4px;
      margin-top: 10px;
      cursor: pointer;
      font-size: 16px;
    }
    button:hover {
      background-color: #0056b3;
    }
    .section {
      margin-bottom: 20px;
    }
    #questionArea {
      margin-top: 20px;
      font-size: 1.2em;
      white-space: pre-wrap;
      background-color: #fff;
      padding: 16px;
      border-radius: 6px;
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
      min-height: 100px;
    }
    #readerLine {
      margin-top: 10px;
    }
    #loading {
      color: gray;
      font-style: italic;
      display: none;
    }
    #buzzerTimer, #bonusTimer, #answer, #bonus, #bonusAnswer, #answerInputDiv, #bonusInputDiv {
      margin-top: 15px;
      font-weight: bold;
    }
    input[type=range] {
      width: 100%;
      height: 6px;
      background: lightgray;
      border-radius: 5px;
      outline: none;
    }
    input[type=range]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: blue;
      cursor: pointer;
    }
    .collapsible {
      background-color: #eee;
      border: none;
      padding: 10px;
      text-align: left;
      outline: none;
      font-size: 16px;
      width: 100%;
      margin-bottom: 5px;
    }
    .content {
      padding-left: 10px;
      display: none;
    }
  </style>

  <!-- MathJax for pretty math rendering -->
  <script>
    window.MathJax = {
      tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] },
      svg: { fontCache: 'global' }
    };
  </script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js" async></script>
</head>

<body>
  <div class="sidebar">
    <h2>Filters</h2>

    <button class="collapsible">Categories</button>
    <div class="content" id="categoryList">
      <label><input type="checkbox" value="PHYSICS"> Physics</label><br>
      <label><input type="checkbox" value="CHEMISTRY"> Chemistry</label><br>
      <label><input type="checkbox" value="BIOLOGY"> Biology</label><br>
      <label><input type="checkbox" value="EARTH AND SPACE"> Earth and Space</label><br>
      <label><input type="checkbox" value="ENERGY"> Energy</label><br>
      <label><input type="checkbox" value="MATH"> Math</label><br>
      <label><input type="checkbox" value="GENERAL SCIENCE"> General Science</label><br>
      <label><input type="checkbox" value="ASTRONOMY"> Astronomy</label><br>
      <label><input type="checkbox" value="COMPUTER SCIENCE"> Computer Science</label><br>
    </div>

    <button class="collapsible">Difficulties</button>
    <div class="content" id="difficultyList">
      <label><input type="checkbox" value="middle_school"> Middle School</label><br>
      <label><input type="checkbox" value="high_school"> High School</label><br>
    </div>

    <div class="section">
      <h4>Bonus Settings</h4>
      <label><input type="radio" name="bonusMode" value="auto" checked> Always</label><br>
      <label><input type="radio" name="bonusMode" value="tossup"> If Tossup Correct</label><br>
      <label><input type="radio" name="bonusMode" value="never"> Never</label>
    </div>

    <div class="section">
      <h4>Reading Speed</h4>
      <input type="range" id="speedSlider" min="1" max="10" value="7">
      <div>Speed: <span id="speedLabel">7</span> (Recommended: 5‚Äì8)</div>
    </div>

    <button onclick="loadQuestion()">Load Question</button>
    <button id="pauseBtn" onclick="togglePause()" style="display:none;">Pause</button>
  </div>

  <div class="main">
    <h1>üî¨ SciBowl QBReader</h1>
    <div id="loading">Loading...</div>
    <div id="questionArea">
      <div id="readerLine"></div>
    </div>

    <div id="buzzerTimer"></div>
    <button id="buzzBtn" style="display:none;" onclick="buzzed()">Buzz!</button>
    <div id="answerInputDiv">
      <input type="text" id="userAnswer" placeholder="Your answer..." />
      <button onclick="submitAnswer()">Submit Answer</button>
    </div>
    <div id="answer"></div>

    <button id="showBonusBtn" style="display:none;" onclick="showBonus()">Show Bonus</button>
    <div id="bonus"></div>
    <div id="bonusTimer"></div>
    <div id="bonusInputDiv">
      <input type="text" id="bonusInput" placeholder="Bonus answer..." />
      <button onclick="submitBonusAnswer()">Submit Bonus</button>
    </div>
    <div id="bonusAnswer"></div>
  </div>

  <script>
    let currentWords = [], wordIndex = 0, readingInterval = null;
    let paused = false, buzzedIn = false, readingStopped = false;
    let questionData = null;

    document.querySelectorAll('.collapsible').forEach(btn => {
      btn.addEventListener("click", function () {
        this.classList.toggle("active");
        const content = this.nextElementSibling;
        content.style.display = content.style.display === "block" ? "none" : "block";
      });
    });

    const speedSlider = document.getElementById("speedSlider");
    speedSlider.addEventListener("input", () => {
      document.getElementById("speedLabel").textContent = speedSlider.value;
    });

    function getCheckedValues(id) {
      return Array.from(document.querySelectorAll(`#${id} input:checked`)).map(cb => cb.value);
    }

    async function loadQuestion() {
      clearInterval(readingInterval);
      wordIndex = 0;
      currentWords = [];
      buzzedIn = false;
      readingStopped = false;
      document.getElementById("readerLine").textContent = "";
      document.getElementById("loading").style.display = "block";
      document.getElementById("answer").style.display = "none";
      document.getElementById("bonus").style.display = "none";
      document.getElementById("bonusAnswer").style.display = "none";
      document.getElementById("buzzBtn").style.display = "inline";
      document.getElementById("answerInputDiv").style.display = "none";
      document.getElementById("showBonusBtn").style.display = "none";
      document.getElementById("bonusInputDiv").style.display = "none";
      document.getElementById("bonusTimer").style.display = "none";

      const categories = getCheckedValues("categoryList");
      const difficulties = getCheckedValues("difficultyList");
      const payload = { categories, difficulties };

      try {
        const res = await fetch("https://sci-bowl-proxy.onrender.com/api/random", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        questionData = data.questions[0];
        currentWords = questionData.tossup_question.split(/\s+/);
        document.getElementById("loading").style.display = "none";
        startWordReading();
      } catch (err) {
        document.getElementById("readerLine").textContent = "‚ùå Failed to load question.";
      }
    }

    function startWordReading() {
      clearInterval(readingInterval);
      const interval = 1100 - parseInt(speedSlider.value) * 100;
      readingInterval = setInterval(() => {
        if (!paused && !readingStopped && wordIndex < currentWords.length) {
          document.getElementById("readerLine").textContent += currentWords[wordIndex++] + " ";
        }
        if (wordIndex >= currentWords.length) {
          clearInterval(readingInterval);
        }
        MathJax.typeset(); // re-render math
      }, interval);
    }

    function togglePause() {
      paused = !paused;
      document.getElementById("pauseBtn").textContent = paused ? "Resume" : "Pause";
    }

    function buzzed() {
      buzzedIn = true;
      readingStopped = true;
      clearInterval(readingInterval);
      document.getElementById("buzzBtn").style.display = "none";
      document.getElementById("answerInputDiv").style.display = "block";
    }

    function submitAnswer() {
      const userAnswer = document.getElementById("userAnswer").value.trim().toLowerCase();
      const correct = questionData.tossup_answer.trim().toLowerCase();
      const result = correct.includes(userAnswer) ? "‚úÖ Correct!" : "‚ùå Incorrect.";
      document.getElementById("answer").innerHTML = `${result}<br><strong>Correct Answer:</strong> ${questionData.tossup_answer}`;
      document.getElementById("answer").style.display = "block";

      if (result.includes("Correct")) {
        const mode = document.querySelector('input[name="bonusMode"]:checked').value;
        if (mode !== "never") {
          document.getElementById("showBonusBtn").style.display = "inline";
        }
      }
    }

    function showBonus() {
      document.getElementById("bonus").textContent = "Bonus: " + questionData.bonus_question;
      document.getElementById("bonus").style.display = "block";
      document.getElementById("bonusInputDiv").style.display = "block";
    }

    function submitBonusAnswer() {
      document.getElementById("bonusAnswer").textContent = "Bonus Answer: " + questionData.bonus_answer;
      document.getElementById("bonusAnswer").style.display = "block";
    }
  </script>
</body>
</html>

